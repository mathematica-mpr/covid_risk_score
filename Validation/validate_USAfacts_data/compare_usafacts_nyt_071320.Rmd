---
title: "Comparison of COVID counts from USAFacts and New York Times - 7/13/20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

library(tidyverse)
library(lubridate)
library(pander)
library(ggrepel)

dat_nyt <- read_csv("NYT_data_071420.csv") #%>% filter(!is.na(fips))

dat_usafacts_cases <- read_csv("covid_confirmed_usafacts_071420.csv") %>%
  gather(date, cases, names(.)[grepl("^\\d",names(.))]) %>%
  rename(fips=countyFIPS, county='County Name', state=State) %>%
  #filter(!fips %in% 0:1) %>%
  mutate(fips = str_pad(fips, width=5, pad="0"),
         date = mdy(date))

dat_usafacts_deaths <- read_csv("covid_deaths_usafacts_071420.csv") %>%
  gather(date, deaths, names(.)[grepl("^\\d",names(.))]) %>%
  rename(fips=countyFIPS, county='County Name', state=State) %>%
  #filter(!fips %in% 0:1) %>%
  mutate(fips = str_pad(fips, width=5, pad="0"),
         date = mdy(date))
```

# {.tabset}
In this document, we explore to what extent the following two data sources for county-level cumulative counts of confirmed COVID-19 cases and deaths are comparable. In our comparison, we focus on cumulative case counts as of 7/13/2020 (data downloaded on 7/14/2020).

**New York Times (NYT)**: The New York times keeps maintains a data set reporting daily cumulative counts of COVID-19 cases and deaths (https://github.com/nytimes/covid-19-data).

**USAFacts**: USAFacts also maintains a data set reporting daily cumulative counts of COVID-19 cases and deaths.

## 1) Comparison of unallocated cases
```{r}
nyt_unknown <- dat_nyt %>% filter(county=="Unknown") %>% filter(date==max(date)) %>% 
  select(state, cases, deaths) %>% mutate(source="NYT") %>%
  filter(state!="Guam")

usafacts_unknown_cases <- dat_usafacts_cases %>% filter(fips=="00000") %>% 
  mutate(val=cases, var="cases") %>%
  filter(date==max(date)) %>% select(state, var, val)

usafacts_unknown_deaths <- dat_usafacts_deaths %>% filter(fips=="00000") %>% 
  mutate(val=deaths, var="deaths") %>%
  filter(date==max(date)) %>% select(state, var, val)

usafacts_unknown <- bind_rows(usafacts_unknown_cases, usafacts_unknown_deaths) %>%
  spread(var, val) %>% mutate(source="USAFacts") %>%
  left_join(tibble(state_name = state.name, state = state.abb), by="state") %>%
  mutate(state=state_name) %>% select(-state_name)
```

### Unallocated cases and deaths by state 
This plot shows only states where there are unallocated cases or deaths in either data source.

```{r}
bind_rows(nyt_unknown, usafacts_unknown) %>% filter(cases>0) %>%
  arrange(desc(cases)) %>% 
  mutate(state = fct_rev(fct_relevel(as.factor(state), unique(.$state)))) %>%
  spread(source, cases) %>% mutate_at(c("USAFacts","NYT"), ~ifelse(is.na(.),0,.)) %>%
  gather("source","cases",c("USAFacts","NYT")) %>%
  gather("var","val", c("cases","deaths")) %>% 
  
  ggplot(aes(x=state, y=val, fill=source)) +
  geom_col(position = position_dodge()) + 
  coord_flip() + facet_grid(.~var) +

  xlab("State") + ylab("Number unallocated") +
  theme_bw()
```

### Deaths categorized as New York City unallocated in USAFacts
There are currently only a handful of such deaths, and no such cases

```{r, results="asis"}
nyc_cases <- dat_usafacts_cases %>% filter(fips=="00001", date==max(date)) %>%
  select(county, state, cases)
nyc_deaths <- dat_usafacts_deaths %>% filter(fips=="00001", date==max(date)) %>%
  select(county, state, deaths)

inner_join(nyc_cases,nyc_deaths, by = c("county","state")) %>% pandoc.table()
```

```{r}
# now filter out unallocated
dat_nyt <- dat_nyt %>% filter(!is.na(fips))
dat_usafacts_cases <- dat_usafacts_cases %>% filter(!fips %in% c("00000","00001"))
dat_usafacts_deaths <- dat_usafacts_deaths %>% filter(!fips %in% c("00000","00001"))
```

## 2) Comparison of counties with reported cases in the two data sets

We check for counties (FIPs codes) where cases were reported in one data set but not in the other.

```{r}
counties_nyt <- dat_nyt %>% select(fips, state, county) %>% distinct() %>% arrange(fips) 
counties_usafacts <- dat_usafacts_cases %>% filter(cases!=0) %>%
  select(fips, state, county) %>% distinct() %>% arrange(fips)
```

All county FIPS codes from the New York Times data are in the USAFacts data with the exception of FIPS codes corresponding to counties in Puerto Rico.

```{r, results="asis"}
dat_nyt %>% anti_join(dat_usafacts_cases, by="fips") %>% count(state, fips) %>% count(state) %>% 
  set_names(c("State","# Counties in NYT but missing from USAFacts")) %>% 
  pandoc.table()
```

There are a few FIPs codes that appear in the USAFacts data but not in the NYT:

- The Grand Princess cruise ship is included in USAFacts but not in NYT

- USA Facts has a row for Russell county, KS whereas NYT has a single row for Kansas City

- USA Facts has rows for each of five counties in New York City, whereas NYT has a single row for New York City

- USA facts has a row for Martinsville City, while NYT does not


```{r, results="asis"}
dat_usafacts_cases %>% anti_join(dat_nyt, by="fips") %>% filter(cases!=0) %>%
  group_by(state, county, fips) %>% 
  summarise(cummulative_cases = max(cases), earliest_date = min(date), 
            latest_date = max(date)) %>%
  pandoc.table(split.table=Inf)
```

## 3) Comparison of cumulative cases for all counties that appear in both data sets
```{r}
bind_rows(dat_nyt %>% select(date, fips, cases) %>% mutate(source="NYT"),
          dat_usafacts_cases %>% select(date, fips, cases) %>% mutate(source="USAFacts")) %>%
  filter(date==max(date), cases>0) %>%
  spread(source, cases) %>% 
  filter(fips %in% c(dat_nyt$fips) & fips %in% c(dat_usafacts_cases$fips)) %>%
  mutate_at(c("NYT","USAFacts"), ~ifelse(is.na(.), 0, .)) %>% 
  ggplot(aes(x=NYT, y=USAFacts)) + geom_point(size=.5) +
  
  theme_bw() + ggtitle("Comparison of cases reported in NYT and in USAFacts", 
                       "For counties included in both sources")
```

### Counties where the case count in USA Facts differs from the case count in NYT by more than 5% {.tabset}
The following table is arranged in descending order of the absolute value of the difference between the two sources.

```{r}
case_diff_tab <- bind_rows(dat_nyt %>% select(date, fips, cases) %>% mutate(source="NYT"),
          dat_usafacts_cases %>% select(date, fips, cases) %>% mutate(source="USAFacts")) %>%
  filter(date==max(date)) %>%
  spread(source, cases) %>%
  mutate_at(c("NYT","USAFacts"), ~ifelse(is.na(.), 0, .)) %>%
  mutate(percent_error = ifelse(NYT==0, ifelse(USAFacts==0, 0, Inf), (USAFacts-NYT)/NYT),
         percent_error = round(percent_error, 3)) %>% 
  filter(percent_error!=0) %>% arrange(desc(abs(percent_error))) %>%
  left_join(dat_usafacts_cases %>% select(state, county, fips) %>% distinct(), by="fips") %>%
  select(state, county, fips, NYT, USAFacts, percent_error) %>%
  filter(abs(percent_error)>.05, NYT>0, USAFacts>0) 
```

#### Plot
```{r}
case_diff_tab %>% 
  mutate(abs_diff = abs(NYT-USAFacts)) %>%
  ggplot(aes(x=NYT, y=USAFacts)) + 
  geom_point() + geom_abline(linetype="dashed") +
  geom_abline(slope = .95, linetype="dotted") +
  geom_abline(slope = 1.05, linetype="dotted") +
  geom_text_repel(data = . %>% filter(rank(-1*abs_diff)<=5), 
                   aes(label=county), size=2, direction="x") +
  xlim(0,27800) + ylim(0,27800) + coord_equal() +
  theme_bw() 
```

#### Table
```{r, results="asis"}
case_diff_tab %>% 
  arrange(desc(abs(NYT-USAFacts))) %>%
  mutate(percent_error = paste0(round(100*percent_error,0),"%")) %>%
  pandoc.table(split.table=Inf)
```

## 4) Comparison of cumulative deaths for all counties that appear in both data sets
```{r}
bind_rows(dat_nyt %>% select(date, fips, deaths) %>% mutate(source="NYT"),
          dat_usafacts_deaths %>% select(date, fips, deaths) %>% mutate(source="USAFacts")) %>%
  filter(date==max(date), deaths>0) %>%
  spread(source, deaths) %>% 
  filter(fips %in% c(dat_nyt$fips) & fips %in% c(dat_usafacts_deaths$fips)) %>%
  mutate_at(c("NYT","USAFacts"), ~ifelse(is.na(.), 0, .)) %>% 
  ggplot(aes(x=NYT, y=USAFacts)) + geom_point(size=.5) +
  
  theme_bw() +
  ggtitle("Comparison of deaths reported in NYT and in USAFacts", 
                       "For counties included in both sources")
```

### Counties where the death count in USA Facts differs from the death count in NYT by more than 5% {.tabset}
The following table is arranged in descending order of the absolute value of the difference between the two sources.

```{r}
death_diff_tab <- bind_rows(dat_nyt %>% select(date, fips, deaths) %>% mutate(source="NYT"),
          dat_usafacts_deaths %>% select(date, fips, deaths) %>% mutate(source="USAFacts")) %>%
  filter(date==max(date)) %>%
  spread(source, deaths) %>%
  mutate_at(c("NYT","USAFacts"), ~ifelse(is.na(.), 0, .)) %>%
  mutate(percent_error = ifelse(NYT==0, ifelse(USAFacts==0, 0, Inf), (USAFacts-NYT)/NYT),
         percent_error = round(percent_error, 3)) %>% 
  filter(percent_error!=0) %>% arrange(desc(abs(percent_error))) %>%
  left_join(dat_usafacts_deaths %>% select(state, county, fips) %>% distinct(), by="fips") %>%
  select(state, county, fips, NYT, USAFacts, percent_error) %>%
  filter(abs(percent_error)>.05, NYT>0, USAFacts>0)
```

#### Plot
```{r}
death_diff_tab %>%
  mutate(abs_diff = abs(NYT-USAFacts)) %>%
  ggplot(aes(x=NYT, y=USAFacts)) + 
  geom_point() + geom_abline(linetype="dashed") +
  geom_abline(slope = .95, linetype="dotted") +
  geom_abline(slope = 1.05, linetype="dotted") +
  geom_text_repel(data = . %>% filter(rank(-1*abs_diff)<=5), 
                   aes(label=county), size=2, direction="x") +
  xlim(0,2750) + ylim(0,2750) + coord_equal() +
  theme_bw() 
```

#### Table
```{r, results="asis"}
death_diff_tab %>% 
  arrange(desc(abs(NYT-USAFacts))) %>%
  mutate(percent_error = paste0(round(100*percent_error,0),"%")) %>%
  pandoc.table(split.table=Inf)
```



