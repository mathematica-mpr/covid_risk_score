---
title: "EBayes sandbox"
author: "Erin Lipman"
date: "8/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=F, warning=F)

library(tidyverse)
library(brms)
library(pander)
library(plotly)

dat <- readRDS("usafacts_082420.RDS") %>% filter(date==max(date), cases>0) %>%
  mutate(CFR = deaths/cases)

dat_state <- dat %>% group_by(state) %>% summarise_at(c("cases","deaths"), sum) %>%
  mutate(CFR = deaths/cases)

dat_nat <- dat %>% summarise_at(c("cases","deaths"), sum) %>%
  mutate(CFR = deaths/cases)
```

The goal of this exploration is to develop a hierarchical Bayesian model to estimate the true case fatality rate (CFR) for each county. In particular, we will start by taking advantage of the grouping of counties within states. The result of the model will be a "denoised" estimate of the CFR for each county in the country. 

The initial motivation for this exploration is to use the distribution of the denoised CFR across counties to estimate to select the shape and scale for a beta prior distribution that will enable the analytic calculation of a denoised posterior CFR for an arbitrary county taking advantage of the conjucacy between a beta prior and a binomial likelihood.  

## Exploratory plots

### Numerical summary of case fatality rates
```{r}
dat %>% pull(CFR) %>% summary()
```

### Case fatality rates by number of 
The most extreme CFRs come from counties with small numbers of cases
```{r}
dat %>% ggplot(aes(x=cases, y=CFR)) + geom_point() +
  scale_x_log10() + theme_bw()
```

### Median and IQR of county CFR by state

The appears to be meaningful clustering of CFR within states, which suggests that a model with a random effect for state is appropriate.

```{r}
dat %>% group_by(state) %>%
  summarise(median = quantile(CFR, .5),
            q25 = quantile(CFR, .25),
            q75 = quantile(CFR, .75)) %>%
  mutate(state = fct_rev(fct_relevel(state, state[order(median)]))) %>%
  ggplot(aes(x=state, y=median, ymin = q25, ymax=q75, color=state)) + 
  geom_pointrange(show.legend = F) +
  coord_flip() + ylab("CFR (median and IQR)") +
  theme_bw()
```


## Modelling 

We fit a binomial model to estimate an adjusted (denoised) CFR for each county by shrinking the county CFR towards the state CFR and shrinking the state CFR towards the national CFR. The prior $N(0,1.6)$ on the intercept is chosen because this prior on the logit scale is approximately uniform over [0,1] when transformed to the probability scale. 

I should note that with these priors, this simple model probably does not require STAN to fit (we could use e.g. glmer). However the stan machinery will be needed if we make the model more complex.

We could in theory obtain more precise estimates by placing a more informative prior on the national CFR, however the gains in precision would likely be small given that there is ample data to estimate the national CFR.

### Model with intercept and state and county random effect

```{r}
stopifnot(length(unique(dat$fips))==nrow(dat))
my_priors1 <- prior(normal(0,1.6), class=Intercept) + prior(normal(0,1), class="sd")

#fit1 <- brm(deaths | trials(cases) ~ (1|state) + (1|fips),  
#                        data = dat, 
#                        family = binomial(link = "logit"),
#    prior = my_priors1,
#    iter=1000,
#    chains=4, cores=2) 

#fit1 %>% saveRDS(file.path("brms_fits","fit1.RDS"))

fit1 <- readRDS(file.path("brms_fits", "fit1.RDS"))
```

```{r}
preds1 <- pp_expect(fit1)

nat1_deaths <- preds1 %>% rowSums()

state1_deaths <- tibble(state = unique(dat$state)) %>%
  mutate(draws = map(state, ~rowSums(preds1[,dat$state==.x, drop=F])))
```

#### Priors
```{r}
prior_summary(fit1)
```

#### Fit summary
The variance estimates for the state random effect and the county random effect are roughly the same and are relatively large, suggesting that there is meaningful variation in CFR both within and between states.

```{r}
fit1
```

#### National CFR
The adjusted national CFR is essentially the same as the unadjusted national CFR, because there is ample data to estimate this CFR. 

```{r, results="asis"}
dat_nat %>% mutate(CFR_adj = mean(nat1_deaths)/cases) %>% pandoc.table()
```

### State CFR
The adjusted state CFRs are very close to the unadjusted state CFRs, because there is ample data to estimate these as well. The regularization on the state random effect may become more important if we do something more complex, such as incorporating a time trend that interacts with state.
```{r}
dat_state %>% left_join(state1_deaths, by="state") %>%
  mutate(CFR_adj = map2(draws, cases, ~(mean(.x)/.y))) %>%
  unnest(CFR_adj) %>% select(-draws) %>%
  
  ggplot(aes(x=CFR, y=CFR_adj, size=cases)) +
  geom_point() + theme_bw()
```


### County CFR
The adjustment on the county-level CFR is much more meaningful. The many points substantially below the diagonal on this plot indicate counties where the unadjusted CFR is very large but the adjusted (denoised) CFR is much more moderate.

```{r}
dat %>%
  mutate(CFR_adj = colMeans(preds1)/cases) %>%
  
  ggplot(aes(x=CFR, y=CFR_adj, size=cases)) +
  geom_point() +
  coord_equal() + 
  geom_abline(color="blue") + theme_bw()
```

### Case fatality rates (adjusted and unadjusted) by number of cases
The relationship between CFR and number of cases looks different after adjustment, in that CFRs for counties with few cases have been shrunken to more moderate values. Interestingly, there is a slight positive relationship (approximately linear on the log scale) between CFR and cases, for both adjusted and unadjusted CFR.

```{r}
dat %>%
  mutate(CFR_adj = colMeans(preds1)/cases) %>%
  gather(var,val,c("CFR","CFR_adj")) %>%
  ggplot(aes(x=cases, y=val)) + geom_point() + geom_smooth(color="blue", se=F, aes(group = var)) +
  scale_x_log10() + 
  facet_grid(.~var) + theme_bw() 
```

### Distribution of CFR by state
Hover over densities to see which state they represent.

```{r}
g<- dat %>%
  mutate(CFR_adj = colMeans(preds1)/cases) %>%
  
  ggplot(aes(x=CFR_adj, color=state)) + 
  geom_density(show.legend = F) + 
  theme_bw() 
ggplotly(g)
```

## Fit beta distribution to overall state-level CFR for use as prior in beta-binomial conjugate adjustment of county CFR at future times

### First fit beta distribution to distribution of county-level CFR nationally.

```{r}
library(fitdistrplus)
dat <- dat %>%  mutate(CFR_adj = colMeans(preds1)/cases)

fit <- fitdist(dat$CFR_adj, "beta", lower=c(0,0))

plot(fit, las = 1) # Checking fit
```

#### Parameter estimates
```{r, results="asis"}
fit$estimate %>% pandoc.table()
```

#### Empirical density versus fitted distribution
```{r, results="asis"}
dat %>% 
  mutate(fitted_dist = rbeta(nrow(dat), fit$estimate[1], fit$estimate[2])) %>%
  gather(var,val,c("CFR_adj",fitted_dist)) %>%
  ggplot(aes(x=val, color=var)) + 
  geom_density() + 
  theme_bw()
```



### Fit a separate distribution per state
```{r, results="asis"}
state_fitted_dists <- dat %>% nest(-state) %>% filter(state!="DC") %>%
  mutate(fit_dist = map(data, ~(fitdist(.x$CFR_adj, "beta", lower=c(0,0))$estimate) %>%
                          as.data.frame() %>% rownames_to_column() %>% set_names(c("par","est")) %>%
                          spread(par,est)),
         n_counties = map(data, nrow),
         deaths = map(data, ~sum(.x$deaths)),
         cases = map(data, ~sum(.x$cases)),
         CFR = map(data, ~(.x$CFR)),
         CFR_adj = map(data, ~(.x$CFR_adj))) %>%
  dplyr::select(-data) %>% unnest(fit_dist, n_counties, deaths, cases)

state_fitted_dists %>% dplyr::select(-CFR_adj) %>%
  arrange(n_counties) %>% 
  mutate(mean_CFR = map(CFR, mean)) %>% unnest(mean_CFR) %>% dplyr::select(-CFR) %>%
  mutate(mean_CFR_fitted = shape1/(shape1+shape2)) %>%
  pandoc.table(split.table=Inf)
```

#### Empirical density versus fitted distribution by state
The number in parentheses after each state indicates the number of counties.

```{r, results="asis", fig.height = 15, fig.width=8}
state_fitted_dists %>% 
  mutate(label = paste0(state, " (", n_counties, ")")) %>%
  arrange(desc(n_counties)) %>%
  mutate(label = fct_relevel(label, label)) %>% 

  mutate(fitted_dist = map2(shape1, shape2, ~rbeta(1000, .x, .y))) %>%
  gather(var,val,c("CFR_adj",fitted_dist)) %>% unnest(val) %>%
  
  ggplot(aes(x=val, color=var)) + 
  geom_density() + facet_wrap(.~label, ncol=5, scales="free") + 
  theme_bw()
```



### Compare adjusted CFR from model to adjusted CFR computed using empirical Bayes with the state-specific beta prior
```{r}
adjust_CFR_EB <- function(deaths, cases, shape1, shape2, ...){
  (deaths + shape1 - 1)/(cases+shape2-1)
}

dat <- dat %>% left_join(state_fitted_dists %>% dplyr::select(state, shape1, shape2), by="state") %>%
  mutate(CFR_adj_EB = pmap(., adjust_CFR_EB)) %>% unnest(CFR_adj_EB)
```

### Plot adjusted CFR from model versus from EB
Adjusted CFRs from EB are generally lower than those from the model, where the two estimates differ. To understand how similar these two adjusted estimates are relative to the unadjusted CFR, we have to look at the unadjusted CFR as well.

```{r}
dat %>%   ggplot(aes(x=CFR_adj, y=CFR_adj_EB)) + 
  geom_abline() + geom_point() + coord_equal() +
  theme_bw()
```

### Plot all three CFR for each county (ordered by model adjusted CFR)?

In most cases, the two adjusted CFRs are similar (relative to the unadjusted CFR). The Empirical Bayes adjustment tends to shrink the CFR to slightly lower values than the model adjustment.

One possible explanation for differences between the two adjustment methods is that in the model, there is a single variance for the county random effects across states, while in the EB method, the fitted beta distributions have differing variances by state.

```{r}
dat %>% mutate(rank_CFR_adj = rank(CFR_adj)) %>%
  gather(type, CFR, c("CFR","CFR_adj","CFR_adj_EB")) %>%
  ggplot(aes(x=rank_CFR_adj, y=CFR, color=type)) + 
  geom_hline(yintercept = dat_nat$CFR, linetype="dashed") +
  geom_point(size=.5) + 
  geom_line(data = . %>% filter(type=="CFR_adj")) +
  ylim(0,.25) +
  theme_bw()
```

### Now plot the adjusted CFR from EB versus the adjusted CFR from the model state
```{r, results="asis", fig.height = 15, fig.width=8}
dat %>% 
  group_by(state) %>% mutate(n_counties=n()) %>% ungroup() %>% filter(n_counties>1) %>%
  mutate(label = paste0(state, " (", n_counties, ")")) %>%
  arrange(desc(n_counties)) %>%
  mutate(label = fct_relevel(label, unique(label))) %>% 

  ggplot(aes(x=CFR_adj, y=CFR_adj_EB)) +
  geom_abline(color="blue") + 
  geom_point() + facet_wrap(.~label, ncol=5, scales="free") + 
  theme_bw()
```

### Compare underreporting factors estimated using adjusted and unadjusted CRF 
Assuming a true mortality rate of 0.0138. The distribution of estimated underreporting factors is much more heavy-tailed for the unadjusted CFRs compared to the adjusted CFRs.

```{r}
true_CFR = .0138
dat %>% mutate(UR_unadjusted = CFR/true_CFR,
               UR_adjusted = CFR_adj/true_CFR,
               UR_adjusted_EB = CFR_adj_EB/true_CFR) %>%
  gather(method, underreporting_factor, c("UR_unadjusted","UR_adjusted","UR_adjusted_EB")) %>%
  dplyr::select(method, underreporting_factor) %>%
  mutate(UR_cat = cut(underreporting_factor, c(-Inf,1,2,3,4,5,10,Inf))) %>% na.omit() %>%
  mutate(method = fct_relevel(method, c("UR_unadjusted","UR_adjusted","UR_adjusted_EB"))) %>%
  
  ggplot(aes(x=UR_cat, fill=method)) + 
  geom_bar(position = position_dodge(.5), width=.5) +
  theme_bw()
```















